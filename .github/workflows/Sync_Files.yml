name: Sync iStoreOS Files

on:
  workflow_dispatch:
  repository_dispatch:
    types: [sync]

jobs:
  build:
    name: Sync iStoreOS Files
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout
      continue-on-error: true
      uses: actions/checkout@main
      with:
        ref: ${{ matrix.target }}

    - name: Setup variables
      run: |
        sudo timedatectl set-timezone 'Asia/Shanghai'
        git config --global user.email "2519840456@qq.com"
        git config --global user.name "Xiaokailnol"

    - name: Sync iStoreOS Files
      run: |
          mkdir -p configs configs/opkg
          curl -L -o configs/x86_64.config https://fw0.koolcenter.com/iStoreOS/x86_64_efi/config.seed
          sed -i '/^CONFIG_ALL_KMODS=y$/d' configs/x86_64.config
          sed -i '/^CONFIG_PACKAGE_luci-app-ota=y$/d;/^CONFIG_PACKAGE_luci-i18n-ota-zh-cn=y$/d' configs/x86_64.config
          curl -L -o configs/rockchip.config https://fw0.koolcenter.com/iStoreOS/r4se/config.seed
          sed -i '/^CONFIG_ALL_KMODS=y$/d' configs/rockchip.config
          sed -i '/^CONFIG_PACKAGE_luci-app-ota=y$/d;/^CONFIG_PACKAGE_luci-i18n-ota-zh-cn=y$/d' configs/rockchip.config
          curl -L -o configs/opkg/feeds.conf https://fw0.koolcenter.com/iStoreOS/x86_64_efi/feeds.conf
          
    - name: Git push
      continue-on-error: true
      run: |
        Emoji=("ğŸ‰" "ğŸ¤" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ¨" "ğŸ’‹" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸ’" "ğŸŒ´" "ğŸš€" "ğŸ›¸" "ğŸ—½" "â›…" "ğŸŒˆ" "ğŸ”¥" "â›„" "ğŸ¶" "ğŸ…" "ğŸ¦„" "ğŸ¤")
        [ -d .git ] && git init
        git add --all
        git commit -sm "${Emoji[$[$RANDOM % ${#Emoji[@]}]]} Sync $(date +%Y-%m-%d" "%H:%M:%S)"
        git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}" HEAD:master
